<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskflow â€“ Verify Email</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/check-list.png">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <!-- Styles -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="auth-container glass">

    <!-- Logo & Header -->
    <div class="auth-logo">
        <i class="bi bi-envelope-check"></i>
        <h4>Verify Your Email</h4>
    </div>

    <!-- Error Alert -->
    <div th:if="${error}" class="auth-alert alert-error">
        <i class="bi bi-exclamation-circle-fill"></i>
        <span th:text="${error}">Invalid or expired code.</span>
    </div>

    <!-- Success Alert -->
    <div th:if="${success}" class="auth-alert alert-success">
        <i class="bi bi-check-circle-fill"></i>
        <span th:text="${success}"></span>
    </div>

    <!-- Info: which email the code was sent to -->
    <p class="auth-hint">
        We sent a 6-digit code to <span th:text="${email}">you@email.com</span>.<br>
        Enter the code below to verify your email.
    </p>

    <!-- OTP Form -->
    <form th:action="@{/auth/verify}" method="post">

        <!-- Hidden email field -->
        <input type="hidden" name="email" th:value="${email}">

        <!-- 6 OTP Boxes -->
        <div class="otp-row">
            <input type="text" name="otp" maxlength="1" class="otp-input" th:classappend="${error} ? 'input-error' : ''"
                   autocomplete="off" oninput="moveToNext(this)" onkeydown="moveBack(event, this)" required>
            <input type="text" name="otp" maxlength="1" class="otp-input" th:classappend="${error} ? 'input-error' : ''"
                   autocomplete="off" oninput="moveToNext(this)" onkeydown="moveBack(event, this)" required>
            <input type="text" name="otp" maxlength="1" class="otp-input" th:classappend="${error} ? 'input-error' : ''"
                   autocomplete="off" oninput="moveToNext(this)" onkeydown="moveBack(event, this)" required>
            <input type="text" name="otp" maxlength="1" class="otp-input" th:classappend="${error} ? 'input-error' : ''"
                   autocomplete="off" oninput="moveToNext(this)" onkeydown="moveBack(event, this)" required>
            <input type="text" name="otp" maxlength="1" class="otp-input" th:classappend="${error} ? 'input-error' : ''"
                   autocomplete="off" oninput="moveToNext(this)" onkeydown="moveBack(event, this)" required>
            <input type="text" name="otp" maxlength="1" class="otp-input" th:classappend="${error} ? 'input-error' : ''"
                   autocomplete="off" oninput="moveToNext(this)" onkeydown="moveBack(event, this)" required>
        </div>

        <!-- Submit -->
        <button type="submit" class="btn-auth">Verify</button>
    </form>

    <!-- Resend link -->
    <a th:href="@{/auth/resend}" class="resend-link">
        <i class="bi bi-arrow-repeat"></i> Didn't receive the code? Resend
    </a>

    <!-- Footer -->
    <div class="auth-footer">
        <p>Back to <a th:href="@{/auth/login}">Sign In</a></p>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Auto-focus first input on load
    document.querySelector('.otp-input').focus();

    // Move focus to next input when a digit is typed
    function moveToNext(input) {
        // Only allow digits
        input.value = input.value.replace(/[^0-9]/g, '');

        if (input.value.length === 1) {
            const next = input.nextElementSibling;
            if (next && next.classList.contains('otp-input')) {
                next.focus();
            }
        }
    }

    // Move focus to previous input on Backspace
    function moveBack(event, input) {
        if (event.key === 'Backspace' && input.value === '') {
            const prev = input.previousElementSibling;
            if (prev && prev.classList.contains('otp-input')) {
                prev.focus();
                prev.value = '';
            }
        }
    }

    // Paste handling: spread pasted digits across all boxes
    document.querySelector('.otp-row').addEventListener('paste', function (e) {
        e.preventDefault();
        const data = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
        const inputs = document.querySelectorAll('.otp-input');
        [...data].forEach((digit, i) => {
            if (inputs[i]) {
                inputs[i].value = digit;
            }
        });
        // Focus the next empty box or the last one
        const nextEmpty = [...inputs].find(inp => !inp.value);
        (nextEmpty || inputs[inputs.length - 1]).focus();
    });
</script>
</body>
</html>